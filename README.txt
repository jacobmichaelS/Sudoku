I still need to refactor a lot of this. :/